name: Start Merge To Dev Environment
run-name: ${{ github.actor }} is Merging ðŸš€
on: workflow_dispatch

jobs:
  MegeBranch:
    runs-on: ubuntu-22.04
    steps:
      - name: TargetBranch
        run: |
          echo "TARGET_BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
        shell: bash
      - name: Get Date
        id: date
        run: |
          echo "DEV_BRANCH_NAME=dev-$(TZ=Asia/Tokyo date '+%m%d')" >> $GITHUB_ENV
        shell: bash
      - name: Check Out Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEV_BRANCH_NAME }}
      - name: Set Git Config
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      - name: merge branch
        run: |
          git fetch --prune --unshallow
          git merge --no-ff --no-commit origin/${{ env.TARGET_BRANCH_NAME }}

          if [[ -n $(git status -s | grep "^UU" | awk '{print substr($0,4,1000)}') ]]; then
            echo "Merge conflict detected. Aborting merge."
            git merge --abort
          else
            git commit -m "Merge target-branch into main"
          fi
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
